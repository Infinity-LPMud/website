---
/**
 * HitCounter.astro â€” Geocities-style animated fire hit counter
 * Fetches from /api/counter.php (POST to increment, GET to read).
 */
interface Props {
  apiUrl?: string;
}
const { apiUrl = "/api/counter.php" } = Astro.props;
---

<div class="hit-counter-wrap" data-api-url={apiUrl}>
  <div class="hc-label">
    <span class="hc-tilde">~</span>
    You Are Visitor Number
    <span class="hc-tilde">~</span>
  </div>
  <div class="hc-fire-border">
    <div class="hc-body">
      <div class="hc-digits">
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
        <div class="hc-cell"><span class="hc-digit">&nbsp;</span></div>
      </div>
    </div>
  </div>
</div>

<style>
  .hit-counter-wrap {
    text-align: center;
    margin: 18px auto 4px;
  }

  /* ---- glowing label ---- */
  .hc-label {
    font-family: "Comic Neue", "Comic Sans MS", cursive;
    color: #ff6600;
    font-size: 13px;
    font-weight: bold;
    margin-bottom: 6px;
    animation: hc-label-glow 2s ease-in-out infinite alternate;
  }

  .hc-tilde { color: #ffcc00; }

  @keyframes hc-label-glow {
    from { text-shadow: 1px 1px 2px #000, 0 0 4px #ff4400; }
    to   { text-shadow: 1px 1px 2px #000, 0 0 8px #ffaa00, 0 0 14px #ff6600; }
  }

  /* ---- animated fire border ---- */
  .hc-fire-border {
    position: relative;
    display: inline-block;
    padding: 5px;
    border-radius: 4px;
    background: linear-gradient(
      90deg,
      #ff0000, #ff4400, #ff8800, #ffcc00, #ffff44,
      #ffcc00, #ff8800, #ff4400, #ff0000,
      #ff4400, #ff8800, #ffcc00, #ffff44,
      #ffcc00, #ff8800, #ff4400, #ff0000
    );
    background-size: 200% 100%;
    animation:
      hc-fire-scroll 2s linear infinite,
      hc-fire-flicker 0.15s ease-in-out infinite alternate;
  }

  /* soft glow behind the border */
  .hc-fire-border::before {
    content: "";
    position: absolute;
    inset: -4px;
    border-radius: 8px;
    background: inherit;
    background-size: inherit;
    animation: hc-fire-scroll 2s linear infinite;
    filter: blur(8px);
    opacity: 0.5;
    z-index: -1;
  }

  /* flame tips along the top edge */
  .hc-fire-border::after {
    content: "";
    position: absolute;
    top: -10px;
    left: 10%;
    right: 10%;
    height: 14px;
    background:
      radial-gradient(ellipse at 10% 100%, #ff4400 0%, transparent 60%),
      radial-gradient(ellipse at 30% 100%, #ffcc00 0%, transparent 50%),
      radial-gradient(ellipse at 50% 100%, #ff6600 0%, transparent 55%),
      radial-gradient(ellipse at 70% 100%, #ffcc00 0%, transparent 50%),
      radial-gradient(ellipse at 90% 100%, #ff4400 0%, transparent 60%);
    filter: blur(2px);
    opacity: 0.7;
    animation: hc-flames-dance 0.4s ease-in-out infinite alternate;
    pointer-events: none;
  }

  @keyframes hc-fire-scroll {
    0%   { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  @keyframes hc-fire-flicker {
    from { filter: brightness(1); }
    to   { filter: brightness(1.15); }
  }

  @keyframes hc-flames-dance {
    0%   { transform: scaleY(1) translateY(0);    opacity: 0.7; }
    100% { transform: scaleY(1.3) translateY(-2px); opacity: 0.5; }
  }

  /* ---- dark inset counter body ---- */
  .hc-body {
    background: #111;
    border: 2px inset #444;
    border-radius: 2px;
    padding: 6px 10px;
  }

  .hc-digits {
    display: flex;
    gap: 3px;
    justify-content: center;
  }

  /* ---- individual digit cells ---- */
  .hc-cell {
    background: #0a0a0a;
    border: 2px inset #555;
    border-radius: 2px;
    width: 26px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  /* ---- chrome / metallic digit text ---- */
  .hc-digit {
    font-family: "Impact", "Arial Black", sans-serif;
    font-size: 26px;
    font-weight: bold;
    line-height: 1;
    display: block;
    background: linear-gradient(
      180deg,
      #ffffff 0%,
      #d0d0d0 15%,
      #a0a0a0 35%,
      #505050 50%,
      #a0a0a0 65%,
      #d0d0d0 85%,
      #ffffff 100%
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    opacity: 0;
    transform: rotateX(90deg);
  }

  .hc-digit.revealed {
    animation: hc-digit-flip 0.4s ease-out forwards;
  }

  @keyframes hc-digit-flip {
    from { opacity: 0; transform: rotateX(90deg); }
    to   { opacity: 1; transform: rotateX(0deg); }
  }
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    var wrap = document.querySelector(".hit-counter-wrap");
    if (!wrap) return;

    var apiUrl = wrap.getAttribute("data-api-url") || "/api/counter.php";
    var digits = wrap.querySelectorAll(".hc-digit");
    var countedKey = "infinity-archive-counted-at";
    var lastCounted = parseInt(localStorage.getItem(countedKey) || "0", 10);
    var alreadyCounted = (Date.now() - lastCounted) < 86400000; /* 24 hours */
    var BASE_COUNT = 0;

    function displayCount(count) {
      var str = String(count).padStart(7, "0");
      for (var i = 0; i < digits.length; i++) {
        (function (el, ch, delay) {
          setTimeout(function () {
            el.textContent = ch;
            el.classList.add("revealed");
          }, delay);
        })(digits[i], str[i], i * 120);
      }
      var marquee = document.getElementById("marquee-visitor-count");
      var footer = document.getElementById("footer-visitor-count");
      var formatted = count.toLocaleString("en-US");
      if (marquee) marquee.textContent = "#" + formatted;
      if (footer) footer.textContent = formatted;
    }

    function getLocalCount() {
      var key = "infinity-archive-hits";
      var count = parseInt(localStorage.getItem(key) || "0", 10);
      if (count < BASE_COUNT) count = BASE_COUNT;
      if (!alreadyCounted) {
        count++;
        localStorage.setItem(key, count.toString());
      }
      return count;
    }

    var method = alreadyCounted ? "GET" : "POST";

    fetch(apiUrl, { method: method })
      .then(function (res) {
        if (!res.ok) throw new Error("not ok");
        return res.json();
      })
      .then(function (data) {
        if (!alreadyCounted) localStorage.setItem(countedKey, String(Date.now()));
        displayCount(data.count);
      })
      .catch(function () {
        var count = getLocalCount();
        if (!alreadyCounted) localStorage.setItem(countedKey, String(Date.now()));
        displayCount(count);
      });
  });
</script>
